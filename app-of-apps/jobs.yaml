# sync-child-app.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: sync-child-app-job-httpd # å®Ÿè¡Œã”ã¨ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªåå‰ã«ã™ã‚‹ãŸã‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŒ–
  annotations:
    # ğŸŒŸ ãƒã‚¤ãƒ³ãƒˆ 1: Hook ã®è¨­å®š
    argocd.argoproj.io/hook: PreSync
    # Hook ã®å®Ÿè¡Œå¾Œã« Job ã‚’å‰Šé™¤
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    # ğŸŒŸ ãƒã‚¤ãƒ³ãƒˆ 2: Hook ã®å®Ÿè¡Œå¯¾è±¡
    argocd.argoproj.io/sync-wave: "10" # è¦ªã® App ãƒªã‚½ãƒ¼ã‚¹ãŒé©ç”¨ã•ã‚ŒãŸå¾Œ (Sync Wave 0 ãªã©) ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®š
spec:
  template:
    spec:
      serviceAccountName: argocd-application-controller # ArgocD ã® ServiceAccount ã‚’ä½¿ç”¨
      containers:
      - name: argocd-cli
        # ArgocD CLI ãŒå«ã¾ã‚Œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ (ä¾‹: quay.io/argoproj/argocd:v2.10.0 ã®ã‚ˆã†ãª ArgocD ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«åˆã‚ã›ãŸã‚‚ã®)
        image: quay.io/argoproj/argocd:v2.10.0 
        command: ["/bin/sh", "-c"]
        args:
        # å®Ÿè¡Œã—ãŸã„ ArgocD CLI ã‚³ãƒãƒ³ãƒ‰
        - |
          # æ¨©é™ã¯ ArgocD Application Controller ã® SA ã‚’ä½¿ç”¨
          # ArgocD Server ã®å†…éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨èªè¨¼æƒ…å ±ã‚’æŒ‡å®š
          ARGOCD_SERVER="argocd-server.argocd.svc.cluster.local" # ArgocD ãŒ 'argocd' Namespace ã«ã‚ã‚‹å ´åˆ
          
          argocd app sync httpd \
            --server $ARGOCD_SERVER \
            --insecure \
            --auth-token $(cat /var/run/secrets/kubernetes.io/serviceaccount/token) \
            --grpc-web \
            --apply-out-of-sync-only \
            --revision HEAD
      restartPolicy: OnFailure
